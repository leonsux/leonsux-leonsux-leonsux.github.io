---
layout: post
title: 闭包那些事儿
date: 2017-11-14
author: Leonsux
catalog: true
tags: JS
---

为了更好的理解闭包，从网上搜罗了很多资料，集各家之精华（自认为），拼拼凑凑自己总结了一下。
## 闭包
闭包是一个能读取其他函数内部变量的函数：
1. 闭包是一个函数
2. 这个函数能读取到其他函数内部的变量（局部变量）
3. 他能让读取到的变量始终保存在内存中

## 闭包的缺陷
闭包函数读取到的变量会一直保存在内存中，不做处理地盲目使用很容易有内存泄漏（内存未释放或无法释放所造成的内存浪费，导致程序运行速度减慢）的风险

## 案例
屁话说了一堆，来点干货
这个是从网上看到的一个案例
```
function fun(n,o){
  console.log(o);
  return {
    fun: function(m){
      return fun(m,n);
    }
  };
}

var a = fun(0);  // ?
a.fun(1);        // ?        
a.fun(2);        // ?
a.fun(3);        // ?

var b = fun(0).fun(1).fun(2).fun(3);  // ?

var c = fun(0).fun(1);  // ?
c.fun(2);        // ?
c.fun(3);
```
当时我把代码粘过来，边看程序边分析，把每一块分析的过程都写了下来
```
function fun(n, o) {
    console.log(o);
    return { // 这里返回一个对象，对象有个fun函数
        fun: function (m) { // 函数返回 调用fun 函数的返回值
            return fun(m, n);
        }
    };
}

var a = fun(0);  // ? 传参时只传了0，所以n是0，o为 undefined；a即为fun返回的对象
// a.fun() 就是闭包函数，var a = fun(0)中的 n=0，o=undefined 都会常驻在内存中
a.fun(1);        // ? 重新调用fun(n, 0)，m = 1，n = 0，console.log(o)，结果为0
a.fun(2);        // ? 0
a.fun(3);        // ? 0

var b = fun(0).fun(1).fun(2).fun(3);  // ?  0 1 2
// 1. fun(0)为对象，此时的n = 0，o = undefined，输出 undefined
// 2. 然后调用对象的fun(m)，m = 1，返回值为调用外部fun(n, o)的返回值，n = 1， o = 0 而这个返回值又是一个对象，输出0
// 3. 然后又调用对象的fun(m)，m = 2，返回值为调用外部fun(n, o)的返回值，n = 2， o = 1 而这个返回值又是一个对象，输出1
// 4. 然后又调用对象的fun(m)，m = 3，返回值为调用外部fun(n, o)的返回值，n = 3， o = 2 而这个返回值又是一个对象，输出2
// 这里指的注意的是每次的n和o的值都不一样，是因为他们分别在不同的函数作用域内，这里每次都调用了一个新的fun()，开辟了一块新空间

var c = fun(0).fun(1);  // ? undefined，0
// 而这里两次的结果都是1，因为他们都是通过c这个对象调用的，就是说因为他们都在同一个函数作用域内
c.fun(2);        // ?  1
c.fun(3);        // ?  1
```
分析的过程简直是一场头脑风暴，稍不留神就会跑偏，总算写完之后赶紧去对照他的答案（当时并没有跑一遍程序），结果发现`var b = fun(0).fun(1).fun(2).fun(3);`这里答案不一样，他给的答案是`undefined, 0, 0, 0`，而我得到的结果是`undefined, 0, 1, 2`，我就又回头看了一遍，觉得自己分析的没问题啊，这时候突然想到我还没跑一遍试试，于是抓紧跑一波，结果果然是站在我这边的：
![闭包.png](http://upload-images.jianshu.io/upload_images/3629578-a24ad6153de774ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
果然，写程序就是得自信点
如果有什么不理解或者觉得我说的有问题的话，欢迎评论